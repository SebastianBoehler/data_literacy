
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Delay Calendar Heatmap</title>
    <style>
        body { margin: 0; padding: 20px; font-family: sans-serif; }
        #calendar-container { width: 100%; }
        .month-label { font-size: 12px; font-weight: bold; }
        .day-label { font-size: 10px; fill: #666; }
        .day { stroke: #fff; stroke-width: 1px; }
        .tooltip {
            position: absolute;
            padding: 10px;
            font: 12px sans-serif;
            background: rgba(255,255,255,0.95);
            border: 1px solid #999;
            border-radius: 6px;
            pointer-events: none;
            opacity: 0;
            box-shadow: 0 3px 10px rgba(0,0,0,0.15);
        }
        h2 { text-align: center; color: #333; }
        .legend-container { text-align: center; margin: 15px 0; font-size: 12px; }
    </style>
</head>
<body>
    <h2>ðŸ“… Daily Average Delays - Calendar Heatmap</h2>
    <div class="legend-container">
        Each cell = one day | Color intensity = average delay (green=early, red=late)
    </div>
    <div id="calendar-container"></div>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script>
        const data = [{"date": "2025-11-11", "avg_delay": 0.37339449541284403, "count": 327}, {"date": "2025-11-12", "avg_delay": 1.0892627412172193, "count": 2021}, {"date": "2025-11-13", "avg_delay": 0.8463104325699746, "count": 1572}, {"date": "2025-11-14", "avg_delay": 0.508237747653806, "count": 1918}, {"date": "2025-11-15", "avg_delay": 0.2729440789473684, "count": 1216}, {"date": "2025-11-16", "avg_delay": 0.17541567695961993, "count": 842}, {"date": "2025-11-17", "avg_delay": 0.858404686795854, "count": 2219}, {"date": "2025-11-18", "avg_delay": 0.7895604395604395, "count": 2002}, {"date": "2025-11-19", "avg_delay": 1.0244866210329806, "count": 3214}, {"date": "2025-11-20", "avg_delay": 0.7526386554621849, "count": 2975}, {"date": "2025-11-21", "avg_delay": 0.49330277565571684, "count": 3927}, {"date": "2025-11-22", "avg_delay": 0.3444311853619729, "count": 2514}, {"date": "2025-11-23", "avg_delay": 0.575653742110009, "count": 1109}, {"date": "2025-11-24", "avg_delay": 0.7469656992084432, "count": 3411}, {"date": "2025-11-25", "avg_delay": 0.9011816838995569, "count": 4062}, {"date": "2025-11-26", "avg_delay": 0.7383761840324764, "count": 3695}, {"date": "2025-11-27", "avg_delay": 0.7930368922550697, "count": 4093}, {"date": "2025-11-28", "avg_delay": 1.1293626495964375, "count": 3593}, {"date": "2025-11-29", "avg_delay": 0.5692838654012079, "count": 2318}, {"date": "2025-11-30", "avg_delay": 0.5173842841765339, "count": 1858}, {"date": "2025-12-01", "avg_delay": 0.7474369189907039, "count": 3765}, {"date": "2025-12-02", "avg_delay": 1.4125, "count": 4048}, {"date": "2025-12-03", "avg_delay": 0.9286656671664167, "count": 3335}, {"date": "2025-12-04", "avg_delay": 1.0169739952718677, "count": 4230}, {"date": "2025-12-05", "avg_delay": 0.9191367654706188, "count": 3846}, {"date": "2025-12-06", "avg_delay": 0.43522675217590473, "count": 2183}, {"date": "2025-12-07", "avg_delay": 0.4518687329079307, "count": 2194}, {"date": "2025-12-08", "avg_delay": 1.9210402815799767, "count": 2557}, {"date": "2025-12-09", "avg_delay": 1.1365507649513213, "count": 3595}, {"date": "2025-12-10", "avg_delay": 1.0367498514557338, "count": 3366}, {"date": "2025-12-11", "avg_delay": 1.69890243902439, "count": 3280}, {"date": "2025-12-12", "avg_delay": 0.8466137716066874, "count": 3529}, {"date": "2025-12-13", "avg_delay": 0.6667364893171345, "count": 2387}, {"date": "2025-12-14", "avg_delay": 0.3396213657876944, "count": 1479}, {"date": "2025-12-15", "avg_delay": 0.576971030436377, "count": 2727}, {"date": "2025-12-16", "avg_delay": 0.5195283018867924, "count": 3180}, {"date": "2025-12-17", "avg_delay": 0.464632331050908, "count": 3359}, {"date": "2025-12-18", "avg_delay": 0.5980490874764002, "count": 3178}, {"date": "2025-12-19", "avg_delay": 0.41837933059307103, "count": 3406}, {"date": "2025-12-20", "avg_delay": 0.4574459058124735, "count": 2357}, {"date": "2025-12-21", "avg_delay": 0.20341786108048512, "count": 1814}, {"date": "2025-12-22", "avg_delay": 0.6658780036968577, "count": 2705}, {"date": "2025-12-23", "avg_delay": 0.41275773195876286, "count": 2328}, {"date": "2025-12-24", "avg_delay": 0.3882790165809034, "count": 1749}, {"date": "2025-12-25", "avg_delay": 0.1382825484764543, "count": 1805}, {"date": "2025-12-26", "avg_delay": 0.27750138197899393, "count": 1809}, {"date": "2025-12-27", "avg_delay": 0.2901456310679612, "count": 2060}, {"date": "2025-12-28", "avg_delay": 0.13424577751892836, "count": 1717}, {"date": "2025-12-29", "avg_delay": 0.3265374580693254, "count": 2683}, {"date": "2025-12-30", "avg_delay": 0.3903114186851211, "count": 2890}, {"date": "2025-12-31", "avg_delay": 0.3335427742870952, "count": 2069}, {"date": "2026-01-01", "avg_delay": 0.5371474188398084, "count": 1879}, {"date": "2026-01-02", "avg_delay": 0.3742101396032329, "count": 2722}, {"date": "2026-01-03", "avg_delay": 0.26131947582467235, "count": 2213}, {"date": "2026-01-04", "avg_delay": 0.3192507204610951, "count": 1735}, {"date": "2026-01-05", "avg_delay": 0.28380193033990764, "count": 2383}, {"date": "2026-01-06", "avg_delay": 0.26133871898442007, "count": 1733}, {"date": "2026-01-07", "avg_delay": 0.6073204042611309, "count": 3661}, {"date": "2026-01-08", "avg_delay": 0.7053163053163054, "count": 3367}, {"date": "2026-01-09", "avg_delay": 0.43618122977346274, "count": 3090}, {"date": "2026-01-10", "avg_delay": 0.45172079495879786, "count": 2063}, {"date": "2026-01-11", "avg_delay": 0.23511282333516786, "count": 1817}, {"date": "2026-01-12", "avg_delay": 0.6245442984315388, "count": 2359}, {"date": "2026-01-13", "avg_delay": 0.5798634812286689, "count": 2344}, {"date": "2026-01-14", "avg_delay": 0.42288401253918495, "count": 3190}, {"date": "2026-01-15", "avg_delay": 0.5754111842105264, "count": 2432}, {"date": "2026-01-16", "avg_delay": 0.38858230256898196, "count": 3153}, {"date": "2026-01-17", "avg_delay": 0.35517979452054793, "count": 2336}, {"date": "2026-01-18", "avg_delay": 0.1637198622273249, "count": 871}];
        const delayMin = 0.13424577751892836;
        const delayMax = 1.9210402815799767;

        // Parse dates
        const parseDate = d3.timeParse("%Y-%m-%d");
        data.forEach(d => { d.dateObj = parseDate(d.date); });

        // Create date map
        const dateMap = new Map(data.map(d => [d.date, d]));

        // Get date range
        const dates = data.map(d => d.dateObj).filter(d => d);
        const minDate = d3.min(dates);
        const maxDate = d3.max(dates);

        // Dimensions
        const cellSize = 17;
        const width = 900;
        const height = 180;
        const marginLeft = 40;

        const container = d3.select("#calendar-container");

        // Color scale (RdYlGn reversed: green=low delay, red=high delay)
        const colorScale = d3.scaleSequential()
            .domain([delayMax, delayMin])
            .interpolator(d3.interpolateRdYlGn);

        // Tooltip
        const tooltip = d3.select("body").append("div").attr("class", "tooltip");

        // Get all weeks in range
        const weeks = d3.timeWeeks(d3.timeWeek.floor(minDate), d3.timeWeek.ceil(maxDate));

        const svg = container.append("svg")
            .attr("width", width)
            .attr("height", height);

        // Day labels (Mon, Wed, Fri)
        const dayLabels = ["", "Mon", "", "Wed", "", "Fri", ""];
        svg.selectAll(".day-label")
            .data(dayLabels)
            .enter()
            .append("text")
            .attr("class", "day-label")
            .attr("x", 10)
            .attr("y", (d, i) => 35 + i * cellSize)
            .text(d => d);

        // Month labels
        const months = d3.timeMonths(minDate, maxDate);
        svg.selectAll(".month-label")
            .data(months)
            .enter()
            .append("text")
            .attr("class", "month-label")
            .attr("x", d => marginLeft + d3.timeWeek.count(minDate, d) * cellSize + cellSize/2)
            .attr("y", 12)
            .text(d => d3.timeFormat("%b")(d));

        // Draw day cells
        const allDays = d3.timeDays(minDate, d3.timeDay.offset(maxDate, 1));

        svg.selectAll(".day")
            .data(allDays)
            .enter()
            .append("rect")
            .attr("class", "day")
            .attr("width", cellSize - 2)
            .attr("height", cellSize - 2)
            .attr("x", d => marginLeft + d3.timeWeek.count(minDate, d) * cellSize)
            .attr("y", d => 20 + d.getDay() * cellSize)
            .attr("fill", d => {
                const key = d3.timeFormat("%Y-%m-%d")(d);
                const entry = dateMap.get(key);
                return entry ? colorScale(entry.avg_delay) : "#eee";
            })
            .attr("rx", 2)
            .on("mouseover", function(event, d) {
                const key = d3.timeFormat("%Y-%m-%d")(d);
                const entry = dateMap.get(key);
                if (entry) {
                    tooltip.transition().duration(200).style("opacity", 0.95);
                    tooltip.html(`<strong>${d3.timeFormat("%B %d, %Y")(d)}</strong><br/>
                        Avg Delay: ${entry.avg_delay.toFixed(2)} min<br/>
                        Departures: ${entry.count.toLocaleString()}`)
                        .style("left", (event.pageX + 10) + "px")
                        .style("top", (event.pageY - 30) + "px");
                }
            })
            .on("mouseout", function() {
                tooltip.transition().duration(500).style("opacity", 0);
            });

        // Legend
        const legendWidth = 150;
        const legendX = width - legendWidth - 30;
        const legend = svg.append("g").attr("transform", `translate(${legendX}, 140)`);

        const defs = svg.append("defs");
        const gradient = defs.append("linearGradient").attr("id", "cal-legend-gradient");
        gradient.selectAll("stop")
            .data([
                {offset: "0%", color: d3.interpolateRdYlGn(1)},
                {offset: "100%", color: d3.interpolateRdYlGn(0)}
            ])
            .enter().append("stop")
            .attr("offset", d => d.offset)
            .attr("stop-color", d => d.color);

        legend.append("rect").attr("width", legendWidth).attr("height", 10)
            .style("fill", "url(#cal-legend-gradient)").attr("rx", 2);
        legend.append("text").attr("y", 22).style("font-size", "9px")
            .text(`${delayMin.toFixed(1)} min`);
        legend.append("text").attr("x", legendWidth).attr("y", 22)
            .attr("text-anchor", "end").style("font-size", "9px")
            .text(`${delayMax.toFixed(1)} min`);

        console.log("Calendar heatmap rendered:", data.length, "days");
    </script>
</body>
</html>
